<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Appointment List</title>
</head>

<body class="bg-gray-100 font-sans">
    <div class="max-w-7xl mx-auto py-10">

        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">
            Appointment List of <%= patient.name %>
        </h1>

        <div class="overflow-x-auto shadow-lg rounded-lg bg-white">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-blue-600 text-white text-lg">
                        <th class="py-3 px-6">Appointment ID</th>
                        <th class="py-3 px-6">Doctor</th>
                        <th class="py-3 px-6">Date</th>
                        <th class="py-3 px-6">Time</th>
                        <th class="py-3 px-6">Purpose</th>
                        <th class="py-3 px-6 text-center">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    <% if (appointments.length> 0) { %>

                        <% appointments.forEach(a=> { %>
                            <tr class="border-b hover:bg-gray-100">
                                <td class="py-3 px-6">
                                    <%= a.id %>
                                </td>
                                <td class="py-3 px-6">
                                    <%= a.doctor_name %>
                                </td>
                                <td class="py-3 px-6">
                                     <%= new Date(a.appointment_date).toLocaleDateString('en-CA') %>
                                </td>
                                <td class="py-3 px-6">
                                    <%= a.appointment_time %>
                                </td>
                                <td class="py-3 px-6">
                                    <%= a.purpose %>
                                </td>

                                <td class="py-3 px-6 text-center flex gap-2 justify-center">

                                    <!-- EDIT BUTTON -->
                                    <button
                                        onclick="openEditModal('<%= a.id %>', '<%= a.doctor_id %>', '<%= a.appointment_date.toISOString().slice(0,10) %>', '<%= a.appointment_time %>', '<%= a.purpose %>', '<%= patient.id %>')"
                                        class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                        Edit
                                    </button>

                                    <!-- DELETE BUTTON -->
                                    <button onclick="openDeleteModal('<%= a.id %>', '<%= patient.id %>')"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                        Delete
                                    </button>

                                </td>
                            </tr>
                            <% }); %>

                                <% } else { %>
                                    <tr>
                                        <td colspan="6" class="py-6 px-6 text-center text-red-600 text-lg font-medium">
                                            No appointments available for this patient.
                                        </td>
                                    </tr>
                                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ============================
            DELETE CONFIRM MODAL
    ============================= -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Confirm Deletion</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this appointment?</p>

            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteModal()"
                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded">Cancel</button>

                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">Yes,
                    Delete</button>
            </div>
        </div>
    </div>


    <!-- ============================
            UPDATE APPOINTMENT MODAL
    ============================= -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">

            <h2 class="text-xl font-bold text-gray-800 mb-4">Update Appointment</h2>

            <form id="updateForm" method="POST" action="/patients/appointment/update">

                <input type="hidden" id="edit_appointment_id" name="appointment_id">
                <input type="hidden" id="edit_patient_id" name="patient_id">

                <div class="mb-3">
                    <label class="font-semibold">Doctor</label>
                    <select id="edit_doctor_id" name="doctor_id" class="w-full p-2 border rounded">
                        <% doctors.forEach(doc=> { %>
                            <option value="<%= doc.id %>">
                                <%= doc.doctor_name %>
                            </option>
                            <% }) %>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="font-semibold">Date</label>
                    <input type="date" id="edit_date" name="appointment_date" class="w-full p-2 border rounded">
                </div>

                <div class="mb-3">
                    <label class="font-semibold">Time</label>
                    <input type="time" id="edit_time" name="appointment_time" class="w-full p-2 border rounded">
                </div>

                <div class="mb-3">
                    <label class="font-semibold">Purpose</label>
                    <input type="text" id="edit_purpose" name="purpose" class="w-full p-2 border rounded">
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeEditModal()"
                        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                    <button class="px-4 py-2 bg-blue-600 rounded text-white hover:bg-blue-700">Update</button>
                </div>

            </form>

        </div>
    </div>

    <!-- ============================
            JAVASCRIPT
    ============================= -->
    <script>
        /*
        ============================================
                    DELETE LOGIC
        ============================================
        */
        let selectedAppointmentId = null;
        let selectedPatientId = null;

        function openDeleteModal(appId, patientId) {
            selectedAppointmentId = appId;
            selectedPatientId = patientId;
            document.getElementById("deleteModal").classList.remove("hidden");
        }

        function closeDeleteModal() {
            document.getElementById("deleteModal").classList.add("hidden");
        }

        document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/patients/appointment/delete";

            form.innerHTML = `
                <input type="hidden" name="appointment_id" value="${selectedAppointmentId}">
                <input type="hidden" name="patient_id" value="${selectedPatientId}">
            `;

            document.body.appendChild(form);
            form.submit();
        });


        /*
        ============================================
                    EDIT / UPDATE LOGIC
        ============================================
        */
        function openEditModal(id, doctorId, date, time, purpose, patientId) {
            document.getElementById("edit_appointment_id").value = id;
            document.getElementById("edit_patient_id").value = patientId;
            document.getElementById("edit_doctor_id").value = doctorId;
            document.getElementById("edit_date").value = date;
            document.getElementById("edit_time").value = time;
            document.getElementById("edit_purpose").value = purpose;
            document.getElementById("editModal").classList.remove("hidden");
        }
        function closeEditModal() {
            document.getElementById("editModal").classList.add("hidden");
        }
    </script>

</body>

</html>